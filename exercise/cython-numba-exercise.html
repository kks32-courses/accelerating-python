

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Accelerating Python with Cython, Numba and JAX &#8212; Accelerating Python with Cython, Numba and JAX</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'exercise/cython-numba-exercise';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../README.html">
  
  
  
  
  
  
    <p class="title logo__title">Accelerating Python with Cython, Numba and JAX</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../README.html">
                    Accelerating Python with Vectorized Numpy, Numba and JAX
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../background.html">Compiled Languages, Interpreted Languages, and JIT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vectorization-jax.html">Vectorization and JAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../heat-flow.html">Heat Flow Example Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../response-spectra.html">Response Spectrum Example</a></li>







</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/kks32-courses/accelerating-python/blob/main/docs/exercise/cython-numba-exercise.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/kks32-courses/accelerating-python" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/kks32-courses/accelerating-python/issues/new?title=Issue%20on%20page%20%2Fexercise/cython-numba-exercise.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/exercise/cython-numba-exercise.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Accelerating Python with Cython, Numba and JAX</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Accelerating Python with Cython, Numba and JAX</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#compiled-languages-interpreted-languages-and-jit">Compiled Languages, Interpreted Languages, and JIT</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compiled-language">Compiled Language</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpreted-language">Interpreted Language</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hybrid-using-just-in-time-compilation">Hybrid using Just In Time Compilation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pros-and-cons">Pros and Cons</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#vectorized-calculation-using-numpy-arrays">Vectorized Calculation Using Numpy Arrays</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#hands-on-cython-and-numba">Hands-on Cython and Numba</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#heat-flow-problem">Heat Flow Problem</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#governing-differential-equation">Governing differential equation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finite-different-approximation-for-a-rectangular-mesh">Finite different approximation for a rectangular mesh</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resulting-equation">Resulting equation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#if-delta-x-delta-y-we-obtain-the-following">If <span class="math notranslate nohighlight">\(\Delta x = \Delta y\)</span> we obtain the following</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-for-t-ij-k-1-and-re-arranging-terms">Solving for <span class="math notranslate nohighlight">\(T_{ij}^{k+1}\)</span> and re-arranging terms</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#note-the-solution-will-become-unstable-if-left-1-frac-4-alpha-delta-t-delta-x-2-right-0-we-therefore-set-the-time-step-as-shown-below">Note: the solution will become unstable if <span class="math notranslate nohighlight">\(\left(1 - \frac{4\alpha \Delta t}{\Delta x^2} \right) &lt; 0\)</span>. We therefore set the time step as shown below.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-time-step-above-we-find-that-left-1-4-gamma-right-0-and-therefore-the-resulting-equation-is">Using the time step above, we find that <span class="math notranslate nohighlight">\(\left(1-4\gamma\right)=0\)</span> and therefore the resulting equation is:</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-input-variables">Define input variables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-using-python-loops">Implementation Using Python Loops</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-using-cython">Implementation Using Cython</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dependencies">Dependencies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-information">Additional information</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-using-numba-jit">Implementation Using Numba JIT</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#using-scipy-s-convolve-operator">Using Scipy’s Convolve Operator</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-heat-maps-to-make-sure-the-algorithms-are-the-same">Plot heat maps to make sure the algorithms are the same</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#large-scale-problem">Large-scale problem</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="accelerating-python-with-cython-numba-and-jax">
<h1>Accelerating Python with Cython, Numba and JAX<a class="headerlink" href="#accelerating-python-with-cython-numba-and-jax" title="Permalink to this heading">#</a></h1>
<blockquote>
<div><p>Scott Brandenberg, UCLA and Krishna Kumar, UT Austin</p>
</div></blockquote>
<p>A Hands-On Tutorial
Wednesday, April 19, 2:00pm - 3:30pm US Central Time</p>
<p>The webinar will feature a hands-on component using DesignSafe Jupyter, so please be sure to register for a DesignSafe user account if you don’t already have one. If your existing account is inactive, reactivate it by resetting your password.</p>
<p>Python is a popular programming language in natural hazards engineering research because it is free and open-source, and has a plethora of powerful packages for handling our community’s computing needs. However, Python is an interpreted language and is inherently slower and less efficient than compiled languages like Fortran, C, and C++. As a result, many scripts written in Python, particularly those involving loops, can run significantly faster with a few minor modifications. This webinar will demonstrate how vectorized calculations using Numpy arrays are significantly faster than the same operations coded in Python. We will demonstrate how to use Cython to compile Python code to C, which can improve performance by orders of magnitude. We will also demonstrate how to use just in time (JIT) compilation and JAX (Numpy on steroids) to accelerate Python, particularly using GPU’s.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%html</span>
<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="nt">table</span><span class="w"> </span><span class="p">{</span><span class="k">float</span><span class="p">:</span><span class="kc">left</span><span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
table {float:left}
</style>
</div></div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="compiled-languages-interpreted-languages-and-jit">
<h1>Compiled Languages, Interpreted Languages, and JIT<a class="headerlink" href="#compiled-languages-interpreted-languages-and-jit" title="Permalink to this heading">#</a></h1>
<p>To understand why execution speed is slower in Python than many other languages requires some background knowledge of compilers vs. interpreters, and compiled languages vs. interpreted languages. This section provides some background information.</p>
<section id="compiled-language">
<h2>Compiled Language<a class="headerlink" href="#compiled-language" title="Permalink to this heading">#</a></h2>
<p>A compiled language uses a compiler to translate source code to machine code (a.k.a. a binary executable file). The compiler reads the entire source code project to create an executable file specific to a particular hardware architecture. Examples of compiled languages are C, C++, and Fortran.</p>
<img src="https://raw.githubusercontent.com/kks32-courses/accelerating-python/main/images/CompiledLanguage.png" width="800">  
Figure 1. Schematic of compiled language operations.
</section>
<section id="interpreted-language">
<h2>Interpreted Language<a class="headerlink" href="#interpreted-language" title="Permalink to this heading">#</a></h2>
<p>An interpreted language uses an interpreter to translate source code to machine code. The interpreter reads the source code line by line at runtime, and produces machine code on the fly. Examples of interpreted languages are Python, Javascript, and Ruby.</p>
<img src="https://raw.githubusercontent.com/kks32-courses/accelerating-python/main/images/InterpretedLanguage.png" width="800">  
Figure 2. Schematic of interpreted language operations.
</section>
<section id="hybrid-using-just-in-time-compilation">
<h2>Hybrid using Just In Time Compilation<a class="headerlink" href="#hybrid-using-just-in-time-compilation" title="Permalink to this heading">#</a></h2>
<p>Just in time (JIT) uses an interpreter to produce compiled code at runtime, and is a hybrid between a compiled language and an interpreted language. The first time the code is run may execute slowly, but subsequent runs will utilize the compiled machine code and will execute quickly.</p>
<img src="https://raw.githubusercontent.com/kks32-courses/accelerating-python/main/images/HybridJIT.png" width="800">  
Figure 3. Schematic of just-in-time (JIT) compilation.
</section>
<section id="pros-and-cons">
<h2>Pros and Cons<a class="headerlink" href="#pros-and-cons" title="Permalink to this heading">#</a></h2>
<p>Compiled languages have faster execution speed than interpreted languages because the compiler has already created the machine code. Interpeted languages have to perform runtime operations that reduce execution speed. For example, Python must check the type of each variable before a simple addition operation to make sure the types are compatible. If they aren’t it returns an error. JIT may exhibit execution speeds comparable to compiled languages, with the caveat that the code must be compiled upon the first execution, which takes some time. Subsequent executions will be faster.</p>
<p>Interpreted languages are often faster for code development because many operations are handled by the interpreter, and need not be written by the code developer. For example, variable types do not need to be declared in Python because the interpeter infers them at rutime. This is very convenient, and allows developers to more rapidly write their code.</p>
<p>Compiled languages allow developers to keep their source code private because they can deploy a binary executable file that users can run on their own computers (assuming hardware compatibility). By contrast, interpreted languages require disclosure of the source code, which must be interpreted every time the code is executed.</p>
<p>Interpreted languages are more portable because the source code is disclosed, and can be interpreted on any user’s computer. Compiled binary executables are hardware-specific, and different binary files may be required for different operating systems (e.g., PC vs. Mac vs. Unix).</p>
<p>Table 1. Pros and cons of compiled, interpreted, and hybrid (JIT).</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head text-center"><p>Compiled</p></th>
<th class="head text-center"><p>Interpreted</p></th>
<th class="head text-center"><p>JIT</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Execution Speed</p></td>
<td class="text-center"><p>✔️</p></td>
<td class="text-center"><p>✖️</p></td>
<td class="text-center"><p>✔️*</p></td>
</tr>
<tr class="row-odd"><td><p>Code Development</p></td>
<td class="text-center"><p>✖️</p></td>
<td class="text-center"><p>✔️</p></td>
<td class="text-center"><p>✔️</p></td>
</tr>
<tr class="row-even"><td><p>Private Code</p></td>
<td class="text-center"><p>✔️</p></td>
<td class="text-center"><p>✖️</p></td>
<td class="text-center"><p>✖️</p></td>
</tr>
<tr class="row-odd"><td><p>Portability</p></td>
<td class="text-center"><p>✖️</p></td>
<td class="text-center"><p>✔️</p></td>
<td class="text-center"><p>✔️</p></td>
</tr>
<tr class="row-even"><td><p>* JIT may have poor execution speed on the first run</p></td>
<td class="text-center"><p></p></td>
<td class="text-center"><p></p></td>
<td class="text-center"><p></p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="vectorized-calculation-using-numpy-arrays">
<h1>Vectorized Calculation Using Numpy Arrays<a class="headerlink" href="#vectorized-calculation-using-numpy-arrays" title="Permalink to this heading">#</a></h1>
<p>Numpy is a the fundamental package for scientific computing in Python. Although Numpy is a Python package, it was not developed in Python. Rather, it is written mostly in C and consists of binary executables compiled from source code. Numpy functions are therefore generally significantly faster than the same operations performed in Python. The term “vectorized operation” refers to passing an entire Numpy array of known data type to an optimized, compiled C code. The example below shows a simple calculation of a harmonic function using vectorized operations compared with the same operation in a Python loop. The vectorized calculation is much faster.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># time step in seconds</span>

<span class="c1"># Number of time steps</span>

<span class="c1"># Frequency in Hz</span>

<span class="c1"># Numpy array containing time vector consisting of 32 bit floating point precision values</span>

<span class="c1"># Vectorized operation that passes time array into Numpy sin function</span>

<span class="c1"># Non-vectorized operation that uses a Python for loop</span>

<span class="c1"># Ratio of execution times</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="hands-on-cython-and-numba">
<h1>Hands-on Cython and Numba<a class="headerlink" href="#hands-on-cython-and-numba" title="Permalink to this heading">#</a></h1>
<p>Python is a popular programming language in natural hazards engineering research because it is free and open-source, and has a plethora of powerful packages for handling our community’s computing needs. However, Python is an interpreted language and is inherently slower and less efficient than compiled languages like Fortran, C, and C++. As a result, many scripts written in Python, particularly those involving loops, can run significantly faster with a few minor modifications. This webinar will demonstrate how vectorized calculations using Numpy arrays and Scipy are significantly faster than the same operations coded in Python. We will demonstrate how to use Cython to compile Python code to C, which can improve performance by orders of magnitude. We will also demonstrate how to use just in time (JIT) compilation to accelerate Python, particularly using GPU’s.</p>
<section id="heat-flow-problem">
<h2>Heat Flow Problem<a class="headerlink" href="#heat-flow-problem" title="Permalink to this heading">#</a></h2>
<p>The relative performance of different coding approaches is demonstrated using a finite difference solution to the 2D transient heat flow problem for a square domain with a constant initial temperature subject to a temperature change on the top.</p>
</section>
<section id="governing-differential-equation">
<h2>Governing differential equation<a class="headerlink" href="#governing-differential-equation" title="Permalink to this heading">#</a></h2>
<p><span class="math notranslate nohighlight">\(\frac{\partial T}{\partial t} = \alpha \left[ \frac{\partial ^2 T}{\partial x^2} + \frac{\partial^2 T}{\partial y^2}\right]\)</span></p>
<p>T = temperature<br />
t = time<br />
x = horizontal dimension<br />
y = vertical dimension<br />
<span class="math notranslate nohighlight">\(\alpha\)</span> = thermal diffusivity</p>
</section>
<section id="finite-different-approximation-for-a-rectangular-mesh">
<h2>Finite different approximation for a rectangular mesh<a class="headerlink" href="#finite-different-approximation-for-a-rectangular-mesh" title="Permalink to this heading">#</a></h2>
<p><span class="math notranslate nohighlight">\(\frac{\partial T}{\partial t} \approx \frac{T_{ij}^{k+1} - T_{ij}^{k}}{\Delta t}\)</span></p>
<p><span class="math notranslate nohighlight">\(\frac{\partial ^2 T}{\partial x^2} \approx \alpha \frac{T_{i+1,j}^k -2T_{i,j}^k + T_{i-1,j}^k}{\Delta x^2}\)</span></p>
<p><span class="math notranslate nohighlight">\(\frac{\partial ^2 T}{\partial y^2} \approx \alpha \frac{T_{1,j+1}^k -2T_{i,j}^k + T_{i,j-1}^k}{\Delta y^2}\)</span></p>
<p><span class="math notranslate nohighlight">\(\Delta x\)</span> = node spacing in x-direction<br />
<span class="math notranslate nohighlight">\(\Delta y\)</span> = node spacing in y-direction<br />
<span class="math notranslate nohighlight">\(\Delta t\)</span> = time step<br />
i = index counter for x-direction<br />
j = index counter for y-direction<br />
k = index counter for time</p>
<section id="resulting-equation">
<h3>Resulting equation<a class="headerlink" href="#resulting-equation" title="Permalink to this heading">#</a></h3>
<p><span class="math notranslate nohighlight">\(\frac{T_{ij}^{k+1} - T_{ij}^{k}}{\Delta t} = \alpha \frac{T_{i+1,j}^k -2T_{i,j}^k + T_{i-1,j}^k}{\Delta x^2} + \alpha \frac{T_{1,j+1}^k -2T_{i,j}^k + T_{i,j-1}^k}{\Delta y^2}\)</span></p>
</section>
<section id="if-delta-x-delta-y-we-obtain-the-following">
<h3>If <span class="math notranslate nohighlight">\(\Delta x = \Delta y\)</span> we obtain the following<a class="headerlink" href="#if-delta-x-delta-y-we-obtain-the-following" title="Permalink to this heading">#</a></h3>
<p><span class="math notranslate nohighlight">\(\frac{T_{ij}^{k+1} - T_{ij}^{k}}{\Delta t} = \alpha \frac{T_{i+1,j}^k + T_{1,j+1}^k -4T_{i,j}^k + T_{i-1,j}^k + T_{i,j-1}^k}{\Delta x^2}\)</span></p>
</section>
<section id="solving-for-t-ij-k-1-and-re-arranging-terms">
<h3>Solving for <span class="math notranslate nohighlight">\(T_{ij}^{k+1}\)</span> and re-arranging terms<a class="headerlink" href="#solving-for-t-ij-k-1-and-re-arranging-terms" title="Permalink to this heading">#</a></h3>
<p><span class="math notranslate nohighlight">\(T_{ij}^{k+1} = \gamma\left(T_{i+1,j}^k + T_{1,j+1}^k + T_{i-1,j}^k + T_{i,j-1}^k\right) + \left(1 - 4\gamma\right)T_{ij}^k\)</span></p>
<p>where <span class="math notranslate nohighlight">\(\gamma = \frac{\alpha \Delta t}{\Delta x^2}\)</span></p>
</section>
<section id="note-the-solution-will-become-unstable-if-left-1-frac-4-alpha-delta-t-delta-x-2-right-0-we-therefore-set-the-time-step-as-shown-below">
<h3>Note: the solution will become unstable if <span class="math notranslate nohighlight">\(\left(1 - \frac{4\alpha \Delta t}{\Delta x^2} \right) &lt; 0\)</span>. We therefore set the time step as shown below.<a class="headerlink" href="#note-the-solution-will-become-unstable-if-left-1-frac-4-alpha-delta-t-delta-x-2-right-0-we-therefore-set-the-time-step-as-shown-below" title="Permalink to this heading">#</a></h3>
<p><span class="math notranslate nohighlight">\(\Delta t = \frac{\Delta x^2}{4\alpha}\)</span></p>
</section>
<section id="using-the-time-step-above-we-find-that-left-1-4-gamma-right-0-and-therefore-the-resulting-equation-is">
<h3>Using the time step above, we find that <span class="math notranslate nohighlight">\(\left(1-4\gamma\right)=0\)</span> and therefore the resulting equation is:<a class="headerlink" href="#using-the-time-step-above-we-find-that-left-1-4-gamma-right-0-and-therefore-the-resulting-equation-is" title="Permalink to this heading">#</a></h3>
<p><span class="math notranslate nohighlight">\(T_{ij}^{k+1} = \gamma\left(T_{i+1,j}^k + T_{i,j+1}^k + T_{i-1,j}^k + T_{i,j-1}^k\right)\)</span></p>
</section>
</section>
<section id="define-input-variables">
<h2>Define input variables<a class="headerlink" href="#define-input-variables" title="Permalink to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">L</span></code>         = plate length<br />
<code class="docutils literal notranslate"><span class="pre">Nt</span></code>        = number of time steps<br />
<code class="docutils literal notranslate"><span class="pre">Nx</span></code>        = number of increments in x-direction (same as y-direction since plate is square)<br />
<code class="docutils literal notranslate"><span class="pre">alpha</span></code>     = thermal diffusivity<br />
<code class="docutils literal notranslate"><span class="pre">dx</span></code>        = node spacing<br />
<code class="docutils literal notranslate"><span class="pre">dt</span></code>        = time increment<br />
<code class="docutils literal notranslate"><span class="pre">T_top</span></code>     = temperature of top of plate<br />
<code class="docutils literal notranslate"><span class="pre">T_left</span></code>    = temperature of left side of plate<br />
<code class="docutils literal notranslate"><span class="pre">T_right</span></code>   = temperature of right side of plate<br />
<code class="docutils literal notranslate"><span class="pre">T_bottom</span></code>  = temperature of bottom of plate<br />
<code class="docutils literal notranslate"><span class="pre">T_initial</span></code> = initial temperature of plate</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">L</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">Nt</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">Nx</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">dx</span> <span class="o">=</span> <span class="n">L</span><span class="o">/</span><span class="n">Nx</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mf">4.0</span><span class="o">/</span><span class="n">alpha</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="n">dx</span><span class="o">/</span><span class="n">dx</span>
<span class="n">T_top</span> <span class="o">=</span> <span class="mf">100.0</span>
<span class="n">T_left</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">T_right</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">T_bottom</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">T_initial</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># Initialize Numpy array T to store temperature values</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">Nt</span><span class="p">,</span><span class="n">Nx</span><span class="p">,</span><span class="n">Nx</span><span class="p">),</span><span class="n">T_initial</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">T</span><span class="p">[:,:,:</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_left</span>
<span class="n">T</span><span class="p">[:,:,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_right</span>
<span class="n">T</span><span class="p">[:,:</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">T_bottom</span>
<span class="n">T</span><span class="p">[:,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T_top</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="implementation-using-python-loops">
<h2>Implementation Using Python Loops<a class="headerlink" href="#implementation-using-python-loops" title="Permalink to this heading">#</a></h2>
<p>The function below utilizes nested Python loops to define the temperature array. It accepts an initialized temperature array <span class="math notranslate nohighlight">\(T\)</span> and <span class="math notranslate nohighlight">\(\gamma\)</span> as arguments and returns the updated temperature array.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calculate_python</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">gamma</span><span class="p">):</span>
    <span class="n">Nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nt</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">T</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="implementation-using-cython">
<h2>Implementation Using Cython<a class="headerlink" href="#implementation-using-cython" title="Permalink to this heading">#</a></h2>
<p>Cython is an optimising static compiler for both the Python programming language and the extended Cython programming language (based on Pyrex). It makes writing C extensions for Python as easy as Python itself.</p>
<p><a class="reference external" href="https://cython.org/">https://cython.org/</a></p>
<section id="dependencies">
<h3>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>C compiler</p></li>
<li><p>Cython package</p></li>
<li><p>Python</p></li>
</ul>
<p>Cython can be implemented in different ways. One way is to create a Cython file with a .pyx extension, and write a separate <a class="reference external" href="http://setup.py">setup.py</a> file that instructs the compiler how to compile your Cython code to C. Another way is to utilize the Cython magic within Jupyter, which is what we will do here.</p>
</section>
<section id="additional-information">
<h3>Additional information<a class="headerlink" href="#additional-information" title="Permalink to this heading">#</a></h3>
<p>To indicate you want to run a cython cell, include %%cython at the top of your notebook cell.</p>
<p>To include hints about native Python code that might slow things down, use %%cython -a. Your goal should be to remove as many yellow highlights as possible, especially inside loops. Yellow highlights indicate Python overhead where the work of the Python interpreter will be compiled into your C code, thereby making it slow.</p>
<p>This example will use typed memoryviews to handle NumPy arrays. <a class="reference external" href="https://cython.readthedocs.io/en/latest/src/userguide/memoryviews.html">https://cython.readthedocs.io/en/latest/src/userguide/memoryviews.html</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># install the Cython package</span>
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>--user<span class="w"> </span>cython

<span class="c1"># load the Cython package</span>
<span class="o">%</span><span class="k">load_ext</span> cython
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: cython in /home/jupyter/.local/lib/python3.9/site-packages (0.29.34)
The cython extension is already loaded. To reload it, use:
  %reload_ext cython
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">cython</span>
import cython
import numpy as np
cimport numpy as np
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="implementation-using-numba-jit">
<h1>Implementation Using Numba JIT<a class="headerlink" href="#implementation-using-numba-jit" title="Permalink to this heading">#</a></h1>
<p>Numba provides several utilities for code generation, but its central feature is the numba.jit() decorator. Using this decorator, you can mark a function for optimization by Numba’s JIT compiler. Various invocation modes trigger differing compilation options and behaviours.</p>
<p><a class="reference external" href="https://numba.pydata.org/numba-doc/latest/user/jit.html">https://numba.pydata.org/numba-doc/latest/user/jit.html</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>--user<span class="w"> </span>numba
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Collecting numba
  Downloading numba-0.56.4-cp39-cp39-manylinux2014_x86_64.manylinux_2_17_x86_64.whl (3.5 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">3.5/3.5 MB</span> <span class=" -Color -Color-Red">19.5 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>00:0100:01
?25hCollecting llvmlite&lt;0.40,&gt;=0.39.0dev0
  Downloading llvmlite-0.39.1-cp39-cp39-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (34.6 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">34.6/34.6 MB</span> <span class=" -Color -Color-Red">20.4 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>00:0100:01
?25hRequirement already satisfied: setuptools in /opt/conda/lib/python3.9/site-packages (from numba) (60.9.3)
Requirement already satisfied: numpy&lt;1.24,&gt;=1.18 in /opt/conda/lib/python3.9/site-packages (from numba) (1.22.2)
Installing collected packages: llvmlite, numba
Successfully installed llvmlite-0.39.1 numba-0.56.4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numba</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="using-scipy-s-convolve-operator">
<h1>Using Scipy’s Convolve Operator<a class="headerlink" href="#using-scipy-s-convolve-operator" title="Permalink to this heading">#</a></h1>
<p>We know that Python loops are slow thanks to the interpreter. We also know that we can use Cython and Numba / JIT to significantly improve performance. It turns out that we can also use the SciPy signal package to run this code efficiently using the convolve operator. This is kind of equivalent to vectorized calculations because we are passing the loops to efficiently compiled C code within SciPy instead of performing those loops in Python.</p>
<p><a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.convolve.html">https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.convolve.html</a></p>
<p><img alt="vectorization" src="https://raw.githubusercontent.com/kks32-courses/accelerating-python/main/images/convolution.png" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">convolve</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Performance Measurement Summary</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">T_python</span> <span class="o">=</span> <span class="n">calculate_python</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pure Python time: = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">T_cython</span> <span class="o">=</span> <span class="n">calculate_cython</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cython time: = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">T_numba</span> <span class="o">=</span> <span class="n">calculate_numba_wrapper</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Numba time (first run): = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">T_numba</span> <span class="o">=</span> <span class="n">calculate_numba_wrapper</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Numba time (second run): = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">T_convolve</span> <span class="o">=</span> <span class="n">calculate_conv</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Python Convolution time: = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="plot-heat-maps-to-make-sure-the-algorithms-are-the-same">
<h2>Plot heat maps to make sure the algorithms are the same<a class="headerlink" href="#plot-heat-maps-to-make-sure-the-algorithms-are-the-same" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">999</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Python&#39;</span><span class="p">:</span><span class="n">T_python</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;Cython&#39;</span><span class="p">:</span><span class="n">T_cython</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;Numba&#39;</span><span class="p">:</span><span class="n">T_numba</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;Convolve&#39;</span><span class="p">:</span><span class="n">T_convolve</span><span class="p">[</span><span class="n">k</span><span class="p">]}</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">pcm</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x-position&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">shrink</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
    <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>    
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y-position&#39;</span><span class="p">)</span>
<span class="c1">#fig.colorbar(pcm)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="large-scale-problem">
<h2>Large-scale problem<a class="headerlink" href="#large-scale-problem" title="Permalink to this heading">#</a></h2>
<p>Cython and Numba are so much faster than pure Python. They are in fact so fast that it’s difficult to observe differences in performance for the small domain we solved previously. So let’s increase the mesh density so the calculations take a little bit longer</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">L</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">Nt</span> <span class="o">=</span> <span class="mi">4000</span>
<span class="n">Nx</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">dx</span> <span class="o">=</span> <span class="n">L</span><span class="o">/</span><span class="n">Nx</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mf">4.0</span><span class="o">/</span><span class="n">alpha</span>
<span class="n">T_top</span> <span class="o">=</span> <span class="mf">100.0</span>
<span class="n">T_left</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">T_right</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">T_bottom</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">T_initial</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Nt</span><span class="p">,</span><span class="n">Nx</span><span class="p">,</span><span class="n">Nx</span><span class="p">))</span>
<span class="n">T</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">T_initial</span><span class="p">)</span>
<span class="n">T</span><span class="p">[:,:,:</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_left</span>
<span class="n">T</span><span class="p">[:,:,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_right</span>
<span class="n">T</span><span class="p">[:,:</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">T_bottom</span>
<span class="n">T</span><span class="p">[:,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T_top</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">T_cython</span> <span class="o">=</span> <span class="n">calculate_cython</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cython time: = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">T_numba</span> <span class="o">=</span> <span class="n">calculate_numba_wrapper</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Numba time: = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./exercise"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Accelerating Python with Cython, Numba and JAX</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#compiled-languages-interpreted-languages-and-jit">Compiled Languages, Interpreted Languages, and JIT</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compiled-language">Compiled Language</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpreted-language">Interpreted Language</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hybrid-using-just-in-time-compilation">Hybrid using Just In Time Compilation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pros-and-cons">Pros and Cons</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#vectorized-calculation-using-numpy-arrays">Vectorized Calculation Using Numpy Arrays</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#hands-on-cython-and-numba">Hands-on Cython and Numba</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#heat-flow-problem">Heat Flow Problem</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#governing-differential-equation">Governing differential equation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finite-different-approximation-for-a-rectangular-mesh">Finite different approximation for a rectangular mesh</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resulting-equation">Resulting equation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#if-delta-x-delta-y-we-obtain-the-following">If <span class="math notranslate nohighlight">\(\Delta x = \Delta y\)</span> we obtain the following</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-for-t-ij-k-1-and-re-arranging-terms">Solving for <span class="math notranslate nohighlight">\(T_{ij}^{k+1}\)</span> and re-arranging terms</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#note-the-solution-will-become-unstable-if-left-1-frac-4-alpha-delta-t-delta-x-2-right-0-we-therefore-set-the-time-step-as-shown-below">Note: the solution will become unstable if <span class="math notranslate nohighlight">\(\left(1 - \frac{4\alpha \Delta t}{\Delta x^2} \right) &lt; 0\)</span>. We therefore set the time step as shown below.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-time-step-above-we-find-that-left-1-4-gamma-right-0-and-therefore-the-resulting-equation-is">Using the time step above, we find that <span class="math notranslate nohighlight">\(\left(1-4\gamma\right)=0\)</span> and therefore the resulting equation is:</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-input-variables">Define input variables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-using-python-loops">Implementation Using Python Loops</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-using-cython">Implementation Using Cython</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dependencies">Dependencies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-information">Additional information</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-using-numba-jit">Implementation Using Numba JIT</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#using-scipy-s-convolve-operator">Using Scipy’s Convolve Operator</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-heat-maps-to-make-sure-the-algorithms-are-the-same">Plot heat maps to make sure the algorithms are the same</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#large-scale-problem">Large-scale problem</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Scott Brandenberg, Krishna Kumar
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>